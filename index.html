<!DOCTYPE html>
<html>
<head>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://use.fontawesome.com/9d6b0dab50.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.0.15/dist/howler.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    $.getScript("https://cdn.rawgit.com/xsf3190/sequencerA/master/jszip.min.js");
  </script>
  
  <script type="text/javascript">

    "use strict";
    
    $(function() {
      
      const DB_NAME="sequencerA";
      const DB_VERSION=2;
      
      var req = indexedDB.deleteDatabase(DB_NAME);
      req.onsuccess = function () {
          console.log("Deleted database successfully");
      };
      req.onerror = function () {
          console.log("Couldn't delete database");
      };
      req.onblocked = function () {
          console.log("Couldn't delete database due to the operation being blocked");
      };
      
      var request = window.indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = function(event) {
        sweetAlert("Why didn't you allow my web app to use IndexedDB?");
        return;
      };
      
      var db;

      request.onsuccess = function(event) {
        console.log("indexedDB.open - success");
        db = event.target.result;
        $("#version").text(DB_VERSION);
        let store = getObjectStore("sounds", 'readonly').count().onsuccess = function(event) {
          let count=parseInt(event.target.result);
          console.log("Count of sounds in store : "+count);
          if (count==0) {
            loadZip2DB('https://cdn.rawgit.com/xsf3190/sequencerA/master/sounds1.zip', 'sounds');
            loadFile2DB('https://cdn.rawgit.com/xsf3190/sequencerA/master/sequencerA.jpg', 'images');
          };
        }
      };
      
      // Generic error handler for all errors targeted at this database's requests!
      if (db) {
        db.onerror = function(event) {
          sweetAlert("Database error: " + event.target.errorCode);
        };
      };
      
      function getObjectStore(store_name, mode) {
        var tx = db.transaction(store_name, mode);
        return tx.objectStore(store_name);
      }

      // This event handles the event whereby a new version of the database needs to be created
      // Either one has not been created before, or a new version number has been submitted via the
      // window.indexedDB.open line above
      request.onupgradeneeded = function(event) {
        console.log("Starting onupgradeneeded");
        var db = event.target.result;

        db.onerror = function(event) {
          sweetAlert("Error loading database: " + event.target.errorCode);
        };
        
        db.createObjectStore("sounds", { autoIncrement: true });
        db.createObjectStore("images", { keyPath: "name" });
        db.createObjectStore("sequences", { autoIncrement: true });
        db.createObjectStore("chains", { autoIncrement: true });
      }
      
      // Show all sounds in sounds store
      function showSounds() {
        let content="<table><thead><tr><th>Name</th><th>Updated</th></thead><tbody>";

        transaction.oncomplete = function(event) {
            $("#soundList").html(content);
        };

        var handleResult = function(event) {  
          var cursor = event.target.result;  
          if (cursor) {  
            content += "<tr data-key=\""+cursor.key+"\"><td class=\"notetitle\">"+cursor.value.title+"</td>";
            content += "<td>"+dtFormat(cursor.value.updated)+"</td>";

            content += "<td><a class=\"btn btn-primary edit\">Edit</a> <a class=\"btn btn-danger delete\">Delete</a></td>";
            content +="</tr>";
            cursor.continue();  
          }  
          else {  
            content += "</tbody></table>";
          }  
        };
        let objectStore = transaction.objectStore("sounds");
        objectStore.openCursor().onsuccess = handleResult;
    }

      function loadZip2DB(zipfile, storename) {
        console.log("Starting loadZip2DB");
        var xhr = new XMLHttpRequest();
        xhr.open('GET', zipfile, true);
        xhr.responseType = 'blob';
        xhr.onload = function(e) {
          if (this.status == 200) {
            JSZip.loadAsync(this.response)                         
              .then(function(zip) {
                 zip.forEach(function (relativePath, zipEntry) {
                   zip.files[relativePath].async('blob')
                   .then(function(data) {
                      let obj={name: zipEntry.name, data: data};
                      let store = getObjectStore(storename, 'readwrite');
                      let req=store.add(obj);
                      req.oncomplete = function(event) {
                        // request.result is the allocated primary Key
                        $("#sounds tr:last").append('<tr data-key="' + request.result + '"><td>' + zipEntry.name + '</td></tr>');
                      }
                   }); 
                 });
              }, function (e) {
                  sweetAlert("Error reading " + zipfile + " : " + e.message);
              });
          }
        };
        xhr.send();
      };
      
      function loadFile2DB(file, storename) {
        console.log("Starting loadFile2DB");
        var xhr = new XMLHttpRequest();
        xhr.open('GET', file, true);
        xhr.responseType = 'blob';
        xhr.onload = function(e) {
          if (this.status == 200) {
            let blob=this.response,
                obj={name: file, data: blob},
                store = getObjectStore(storename, 'readwrite'),
                request=store.put(obj);
          }
        };
        xhr.send();
      };      
      
    });
    
  </script>
  
</head>

<body>
  
  <p>
    <img src="https://cdn.rawgit.com/xsf3190/sequencerA/master/sequencerA.jpg" height="30px">
  </p>
  
  <table id="sounds">
  </table>
  
  <footer>
    <p>Created by Adam K. Brown, 2018</p>
    <p id="version"></p> 
  </footer>
  
  
</body>

</html>
