<!DOCTYPE html>
<html>
<head>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://use.fontawesome.com/9d6b0dab50.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.0.15/dist/howler.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    $.getScript("https://cdn.rawgit.com/xsf3190/sequencerA/master/jszip.min.js");
  </script>
  
  <script type="text/javascript">

    "use strict";
    
    $(function() {
      
      var request = window.indexedDB.open("sequencerA", 1);
      request.onerror = function(event) {
        sweetAlert("Why didn't you allow my web app to use IndexedDB?");
        return;
      };
      
      var db, sounds, sequences, chains;

      request.onsuccess = function(event) {
        db = event.target.result;
        //displayData();
      };
      
      // Generic error handler for all errors targeted at this database's requests!
      if (db) {
        db.onerror = function(event) {
          sweetAlert("Database error: " + event.target.errorCode);
        };
      };
      
      function getObjectStore(store_name, mode) {
        var tx = db.transaction(store_name, mode);
        return tx.objectStore(store_name);
      }

      // This event handles the event whereby a new version of the database needs to be created
      // Either one has not been created before, or a new version number has been submitted via the
      // window.indexedDB.open line above
      request.onupgradeneeded = function(event) {
        var db = event.target.result;

        db.onerror = function(event) {
          sweetAlert("Error loading database: " + event.target.errorCode);
        };
        
        sounds = db.createObjectStore("sounds", { keyPath: 'id', autoincrement: true });
        sequences = db.createObjectStore("sequences", { autoincrement: true });
        chains = db.createObjectStore("chains", { autoincrement: true });
        
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://cdn.rawgit.com/xsf3190/sequencerA/master/sounds.zip', true);
        xhr.responseType = 'blob';

        xhr.onload = function(e) {
          if (this.status == 200) {
            var store = getObjectStore('sounds', 'read');
            JSZip.loadAsync(this.response)                         
              .then(function(zip) {
                  zip.forEach(function (relativePath, zipEntry) {
                      zip.files[relativePath].async('text')
                      .then(function(data) {
                         var obj={name: zipEntry.name, data: data};
                         var request;
                         request=store.add(obj);
                         //console.log(zipEntry.name);
                         $("body").append("<p>"+zipEntry.name+"</p>");
                      }); 
                  });
              }, function (e) {
                  sweetAlert("Error reading sounds.zip - " + e.message);
              });
          }
        };

        xhr.send();
      };
      
    });
    
  </script>
  
</head>

<body>
  
  <p>Files in sounds.zip - 8</p>
  
  
</body>

</html>
